name: Windows11_25H2_amd64

on: workflow_dispatch
# on: [push, pull_request]

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64
  MAIN_AUTOUNATTEND_PATH: '$oem$/$$/Panther/autounattend.xml'
  BACKUP_AUTOUNATTEND_PATH: '../Config/autounattend.xml'

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest

    steps:
    # 检出本仓库
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # 获取所有历史记录以支持多级目录

    # 准备 autounattend.xml 配置文件
    - name: Prepare autounattend.xml
      shell: pwsh
      run: |
        Write-Host "准备 autounattend.xml 配置文件..."
        
        # 确定最终使用的配置文件路径
        $targetPath = "${{env.FILE_NAME}}\${{env.MAIN_AUTOUNATTEND_PATH}}"
        $mainConfig = "${{env.FILE_NAME}}/${{env.MAIN_AUTOUNATTEND_PATH}}"
        $backupConfig = "${{env.BACKUP_AUTOUNATTEND_PATH}}"
        
        # 检查主配置文件是否存在
        if (Test-Path $mainConfig) {
            Write-Host "✓ 使用主配置文件: $mainConfig"
        } else {
            Write-Host "⚠ 主配置文件不存在，检查备用配置文件..."
            if (Test-Path $backupConfig) {
                Write-Host "✓ 使用备用配置文件: $backupConfig"
                # 创建目录结构
                $directory = Split-Path $targetPath -Parent
                if (!(Test-Path $directory)) {
                    New-Item -ItemType Directory -Force -Path $directory | Out-Null
                }
                # 复制备用配置文件
                Copy-Item -Path $backupConfig -Destination $targetPath -Force
                Write-Host "✓ 备用配置文件已复制到目标位置"
            } else {
                Write-Error "❌ 主备配置文件均不存在！"
                Write-Error "主配置文件路径: $mainConfig"
                Write-Error "备用配置文件路径: $backupConfig"
                exit 1
            }
        }
        
        # 验证配置文件存在
        if (Test-Path $targetPath) {
            Write-Host "✓ 最终配置文件已就绪: $targetPath"
            # 显示配置文件基本信息
            $fileInfo = Get-Item $targetPath
            Write-Host "文件大小: $($fileInfo.Length) 字节"
            Write-Host "最后修改: $($fileInfo.LastWriteTime)"
        } else {
            Write-Error "❌ 配置文件准备失败！"
            exit 1
        }

    # 制作ISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd ${{env.FILE_NAME}}
        dir
        echo "开始制作ISO..."
        uup_download_windows.cmd
        if %errorlevel% neq 0 (
          echo "ISO制作失败！"
          exit /b 1
        )

    # 验证ISO文件
    - name: Verify ISO files
      shell: pwsh
      run: |
        Write-Host "验证ISO文件..."
        cd ${{env.FILE_NAME}}
        $isoFiles = Get-ChildItem -Filter "*.iso"
        if ($isoFiles.Count -eq 0) {
            Write-Error "❌ 未找到ISO文件！"
            exit 1
        }
        foreach ($iso in $isoFiles) {
            Write-Host "✓ 找到ISO: $($iso.Name) - $([math]::round($iso.Length/1GB, 2)) GB"
        }

    # 验证生成的ISO中是否包含autounattend.xml
    - name: Verify autounattend.xml in ISO
      shell: pwsh
      run: |
        Write-Host "验证ISO中的autounattend.xml配置..."
        cd ${{env.FILE_NAME}}
        $isoFiles = Get-ChildItem -Filter "*.iso" | Select-Object -First 1
        if ($isoFiles) {
            # 挂载ISO检查内容（可选步骤）
            Write-Host "ISO文件: $($isoFiles.Name)"
            Write-Host "如果需要，可以在此处添加挂载ISO验证autounattend.xml的逻辑"
        }

    # 打包
    - name: Package binaries
      run: |
        echo "开始打包..."
        7z a -v1950M ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z ./${{env.FILE_NAME}}/*.iso -mx=9
        if errorlevel 1 (
          echo "打包失败！"
          exit /b 1
        )

    # 上传镜像
    - uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*

    # 发布镜像
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        files: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*

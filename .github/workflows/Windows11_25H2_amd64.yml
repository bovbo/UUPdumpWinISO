name: Windows11_25H2_amd64

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      use_primary_config:
        description: 'æ˜¯å¦ä½¿ç”¨ä¸»ç”¨é…ç½® (Windows11_25H2_amd64/$oem$/$$/Panther/autounattend.xml)'
        type: boolean
        default: true
        required: false
      skip_oem_integration:
        description: 'è·³è¿‡æ— äººå€¼å®ˆé…ç½®é›†æˆ (æ„å»ºçº¯å‡€ISO)'
        type: boolean
        default: false
        required: false
  push:  # æ¨é€ä»£ç æ—¶è‡ªåŠ¨è§¦å‘
    paths:
      - '.github/workflows/Windows11_25H2_amd64.yml'
      - 'Windows11_25H2_amd64/**'
      - 'Config/**'
    branches: [ main, master ]
  pull_request:  # åˆ›å»ºPRæ—¶è§¦å‘
    paths:
      - 'Windows11_25H2_amd64/**'
      - 'Config/**'

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64
  # é…ç½®æ–‡ä»¶è·¯å¾„å®šä¹‰
  PRIMARY_CONFIG_PATH: 'Windows11_25H2_amd64/$oem$/$$/Panther/autounattend.xml'
  BACKUP_CONFIG_PATH: 'Config/autounattend.xml'
  TARGET_OEM_PATH: 'Windows11_25H2_amd64/$oem$/$$/Panther/'

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 120  # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
    # 1. æ£€å‡ºä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # 2. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
    - name: Show build info
      shell: cmd
      run: |
        echo ========================================
        echo ğŸªŸ Windows 11 25H2 amd64 ISO æ„å»º
        echo ========================================
        echo æ„å»ºç‰ˆæœ¬: %Build_VERSION%
        echo æ–‡ä»¶ç›®å½•: %FILE_NAME%
        echo è§¦å‘æ–¹å¼: ${{ github.event_name }}
        echo æ˜¯å¦æ‰‹åŠ¨è§¦å‘ä½¿ç”¨ä¸»ç”¨é…ç½®: ${{ inputs.use_primary_config || 'æœªæŒ‡å®š' }}
        echo æ˜¯å¦è·³è¿‡OEMé›†æˆ: ${{ inputs.skip_oem_integration || 'æœªæŒ‡å®š' }}
        echo ========================================

    # 3. æ™ºèƒ½éƒ¨ç½²æ— äººå€¼å®ˆé…ç½®æ–‡ä»¶
    - name: Deploy autounattend.xml (æ™ºèƒ½é€‰æ‹©)
      id: deploy_config
      shell: cmd
      run: |
        echo å¼€å§‹éƒ¨ç½²æ— äººå€¼å®ˆé…ç½®æ–‡ä»¶...
        echo ä¸»ç”¨é…ç½®è·¯å¾„: %PRIMARY_CONFIG_PATH%
        echo å¤‡ç”¨é…ç½®è·¯å¾„: %BACKUP_CONFIG_PATH%
        
        # æ£€æŸ¥æ˜¯å¦è·³è¿‡OEMé›†æˆ
        if "%{{ inputs.skip_oem_integration }}%" == "true" (
          echo â­ï¸ ç”¨æˆ·é€‰æ‹©è·³è¿‡æ— äººå€¼å®ˆé…ç½®é›†æˆï¼Œå°†æ„å»ºçº¯å‡€ISO
          echo SKIP_OEM=true >> "%GITHUB_OUTPUT%"
          exit 0
        )
        
        # ç¡®å®šä½¿ç”¨å“ªä¸ªé…ç½®æ–‡ä»¶
        set USE_PRIMARY=true
        
        # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é€‰æ‹©
        if not "%{{ github.event_name }}%" == "workflow_dispatch" (
          echo è‡ªåŠ¨è§¦å‘æ¨¡å¼ï¼Œå°è¯•æŸ¥æ‰¾å¯ç”¨é…ç½®...
        ) else (
          echo æ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼Œæ£€æŸ¥ç”¨æˆ·é€‰æ‹©...
          if "%{{ inputs.use_primary_config }}%" == "true" (
            echo ç”¨æˆ·é€‰æ‹©ä½¿ç”¨ä¸»ç”¨é…ç½®
            set USE_PRIMARY=true
          ) else (
            echo ç”¨æˆ·é€‰æ‹©ä¸ä½¿ç”¨ä¸»ç”¨é…ç½®ï¼Œå°†å°è¯•ä½¿ç”¨å¤‡ç”¨é…ç½®
            set USE_PRIMARY=false
          )
        )
        
        # æ£€æŸ¥ä¸»ç”¨é…ç½®æ˜¯å¦å­˜åœ¨
        if "%USE_PRIMARY%" == "true" (
          if exist "%PRIMARY_CONFIG_PATH%" (
            echo âœ… ä¸»ç”¨é…ç½®æ–‡ä»¶å­˜åœ¨
            echo CONFIG_SOURCE=primary >> "%GITHUB_OUTPUT%"
            echo CONFIG_USED=true >> "%GITHUB_OUTPUT%"
            goto :config_ready
          ) else (
            echo âš ï¸ ä¸»ç”¨é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†å°è¯•å¤‡ç”¨é…ç½®
          )
        )
        
        # æ£€æŸ¥å¤‡ç”¨é…ç½®æ˜¯å¦å­˜åœ¨
        if exist "%BACKUP_CONFIG_PATH%" (
          echo âœ… å¤‡ç”¨é…ç½®æ–‡ä»¶å­˜åœ¨
          echo CONFIG_SOURCE=backup >> "%GITHUB_OUTPUT%"
          echo CONFIG_USED=true >> "%GITHUB_OUTPUT%"
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          if not exist "%TARGET_OEM_PATH%" (
            mkdir "%TARGET_OEM_PATH%"
            echo åˆ›å»ºç›®å½•: %TARGET_OEM_PATH%
          )
          
          # å¤åˆ¶å¤‡ç”¨é…ç½®æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
          copy "%BACKUP_CONFIG_PATH%" "%TARGET_OEM_PATH%"
          echo å·²å°†å¤‡ç”¨é…ç½®å¤åˆ¶åˆ°: %TARGET_OEM_PATH%
          goto :config_ready
        ) else (
          echo âš ï¸ å¤‡ç”¨é…ç½®æ–‡ä»¶ä¹Ÿä¸å­˜åœ¨
          echo CONFIG_SOURCE=none >> "%GITHUB_OUTPUT%"
          echo CONFIG_USED=false >> "%GITHUB_OUTPUT%"
          echo â„¹ï¸ å°†æ„å»ºä¸å«æ— äººå€¼å®ˆé…ç½®çš„ISO
          goto :end
        )
        
        :config_ready
        echo âœ… æ— äººå€¼å®ˆé…ç½®æ–‡ä»¶å·²å°±ç»ª
        echo é…ç½®æ–‡ä»¶ä½ç½®: %TARGET_OEM_PATH%autounattend.xml
        
        :end
        echo é…ç½®æ–‡ä»¶éƒ¨ç½²æ­¥éª¤å®Œæˆ

    # 4. éªŒè¯é…ç½®æ–‡ä»¶ (ä»…å½“ä½¿ç”¨é…ç½®æ—¶)
    - name: Validate autounattend.xml
      if: steps.deploy_config.outputs.CONFIG_USED == 'true'
      shell: powershell
      continue-on-error: true  # éªŒè¯å¤±è´¥ä¹Ÿä¸åœæ­¢æ„å»º
      run: |
        $configPath = "${{ env.TARGET_OEM_PATH }}autounattend.xml"
        Write-Host "éªŒè¯é…ç½®æ–‡ä»¶: $configPath"
        
        try {
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $configPath)) {
            throw "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $configPath"
          }
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          $fileSize = (Get-Item $configPath).Length
          Write-Host "æ–‡ä»¶å¤§å°: $fileSize å­—èŠ‚"
          
          if ($fileSize -lt 100) {
            Write-Warning "é…ç½®æ–‡ä»¶å¯èƒ½è¿‡å°ï¼Œè¯·æ£€æŸ¥å†…å®¹"
          }
          
          # å°è¯•è¯»å–ä¸ºXMLéªŒè¯åŸºæœ¬è¯­æ³•
          try {
            [xml]$config = Get-Content $configPath -ErrorAction Stop
            Write-Host "âœ… XMLè¯­æ³•éªŒè¯é€šè¿‡"
            
            # æ£€æŸ¥å…³é”®ç»„ä»¶
            $components = @(
              "Microsoft-Windows-Setup",
              "Microsoft-Windows-Shell-Setup"
            )
            
            foreach ($comp in $components) {
              $node = $config.SelectSingleNode("//*[@name='$comp']")
              if ($node) {
                Write-Host "  æ‰¾åˆ°ç»„ä»¶: $comp"
              } else {
                Write-Warning "  æœªæ‰¾åˆ°ç»„ä»¶: $comp"
              }
            }
          } catch {
            Write-Warning "XMLè¯­æ³•éªŒè¯å¤±è´¥: $_"
          }
          
          # æ˜¾ç¤ºå‰å‡ è¡Œå†…å®¹
          Write-Host "é…ç½®æ–‡ä»¶å‰5è¡Œå†…å®¹:"
          Get-Content $configPath -Head 5 | ForEach-Object { Write-Host "  $_" }
          
        } catch {
          Write-Warning "é…ç½®æ–‡ä»¶éªŒè¯å‡ºé”™: $_"
        }

    # 5. åˆ¶ä½œISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd %FILE_NAME%
        echo å½“å‰ç›®å½•: %CD%
        echo ç›®å½•å†…å®¹:
        dir
        
        echo å¼€å§‹è¿è¡ŒUUPè½¬æ¢è„šæœ¬...
        echo å¼€å§‹æ—¶é—´: %time%
        
        # è¿è¡ŒUUPè½¬æ¢è„šæœ¬
        uup_download_windows.cmd
        
        echo ç»“æŸæ—¶é—´: %time%
        echo UUPè½¬æ¢å®Œæˆ!

    # 6. æŸ¥çœ‹ç”Ÿæˆçš„ISOæ–‡ä»¶
    - name: Check generated ISO
      shell: cmd
      run: |
        cd %FILE_NAME%
        echo ISOæ–‡ä»¶ç”Ÿæˆä½ç½®: %CD%
        echo ç”Ÿæˆçš„ISOæ–‡ä»¶:
        dir *.iso
        
        # æ£€æŸ¥ISOæ–‡ä»¶å¤§å°
        for %%i in (*.iso) do (
          echo æ–‡ä»¶: %%~nxi
          echo å¤§å°: %%~zi å­—èŠ‚ (çº¦ %%~zi/1048576 MB)
        )

    # 7. æ‰“åŒ…åˆ†å·å‹ç¼©
    - name: Package binaries
      shell: cmd
      run: |
        echo å¼€å§‹æ‰“åŒ…ISOæ–‡ä»¶...
        
        # æ£€æŸ¥ISOæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not exist "%FILE_NAME%\*.iso" (
          echo âŒ é”™è¯¯: æœªæ‰¾åˆ°ISOæ–‡ä»¶!
          exit 1
        )
        
        # è®¾ç½®å‹ç¼©åŒ…åç§°
        set ARCHIVE_NAME=%FILE_NAME%-%Build_VERSION%
        
        # ç¡®ä¿å®‰è£…äº†7-Zip
        where 7z >nul 2>nul
        if errorlevel 1 (
          echo æ­£åœ¨å®‰è£…7-Zip...
          curl -L https://www.7-zip.org/a/7zr.exe -o 7zr.exe
          set ZIP_TOOL=7zr.exe
        ) else (
          set ZIP_TOOL=7z
        )
        
        # åˆ›å»ºå‹ç¼©åŒ… (åˆ†å·1950Mä»¥é€‚åº”GitHub Releasesé™åˆ¶)
        echo æ­£åœ¨åˆ›å»ºåˆ†å·å‹ç¼©åŒ…: %ARCHIVE_NAME%.7z
        %ZIP_TOOL% a -v1950M "%ARCHIVE_NAME%.7z" "./%FILE_NAME%/*.iso" -mx=9
        
        # æ˜¾ç¤ºå‹ç¼©ç»“æœ
        echo å‹ç¼©å®Œæˆ! ç”Ÿæˆçš„æ–‡ä»¶:
        dir "%ARCHIVE_NAME%.7z*"

    # 8. ä¸Šä¼ åˆ°æ„å»ºäº§ç‰©
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: |
          ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*
          ${{env.FILE_NAME}}/*.log
        retention-days: 7
        if-no-files-found: error

    # 9. åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ (ä»…æ‰‹åŠ¨è§¦å‘æ—¶)
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}-${{ github.run_number }}
        name: Windows 11 25H2 amd64 (${{env.Build_VERSION}})
        body: |
          ## Windows 11 25H2 amd64 ISO
          
          ### æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ env.Build_VERSION }}
          - **æ„å»ºç¼–å·**: ${{ github.run_number }}
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          - **æ„å»ºæ—¶é—´**: ${{ github.run_started_at }}
          
          ### æ— äººå€¼å®ˆé…ç½®
          ${{ steps.deploy_config.outputs.CONFIG_USED == 'true' && format('
          - **é…ç½®æ–‡ä»¶**: {0} ({1})
          - **é›†æˆçŠ¶æ€**: âœ… å·²é›†æˆ', steps.deploy_config.outputs.CONFIG_SOURCE == 'primary' && 'ä¸»ç”¨é…ç½®' || 'å¤‡ç”¨é…ç½®', steps.deploy_config.outputs.CONFIG_SOURCE) || '- **é›†æˆçŠ¶æ€**: âšª æœªé›†æˆ (çº¯å‡€ISO)' }}
          
          ${{ inputs.skip_oem_integration == 'true' && '- **å¤‡æ³¨**: ç”¨æˆ·é€‰æ‹©è·³è¿‡æ— äººå€¼å®ˆé…ç½®é›†æˆ' || '' }}
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½æ‰€æœ‰ `.7z.001`, `.7z.002`... åˆ†å·æ–‡ä»¶
          2. ä½¿ç”¨ [7-Zip](https://www.7-zip.org/) è§£å‹ç¬¬ä¸€ä¸ªåˆ†å· (.7z.001)
          3. å¾—åˆ°å®Œæ•´çš„ Windows 11 ISO æ–‡ä»¶
          
          ### æ ¡éªŒä¿¡æ¯
          - **æ„å»ºå·¥ä½œæµ**: [${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ---
          
          *æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºç”Ÿæˆï¼Œä»…ä¾›æµ‹è¯•å’Œå­¦ä¹ ä½¿ç”¨ã€‚*
          
        draft: false
        prerelease: false
        files: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 10. æ„å»ºå®Œæˆé€šçŸ¥
    - name: Build completion status
      if: always()
      shell: cmd
      run: |
        echo ========================================
        echo ğŸ—ï¸  æ„å»ºä»»åŠ¡å®Œæˆ
        echo ========================================
        echo ä»»åŠ¡çŠ¶æ€: ${{ job.status }}
        echo æ„å»ºç‰ˆæœ¬: %Build_VERSION%
        echo è¿è¡Œç¼–å·: ${{ github.run_number }}
        echo é…ç½®æ–‡ä»¶: ${{ steps.deploy_config.outputs.CONFIG_SOURCE || 'æœªä½¿ç”¨' }}
        echo ========================================
        
        # æ ¹æ®æ„å»ºçŠ¶æ€æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
        if "${{ job.status }}" == "success" (
          echo âœ… æ„å»ºæˆåŠŸ!
        ) else (
          echo âŒ æ„å»ºå¤±è´¥!
        )

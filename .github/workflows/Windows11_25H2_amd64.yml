name: Windows11_25H2_amd64

# ç®€åŒ–è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:
  push:
    paths:
      - 'Windows11_25H2_amd64/**'
    branches: [ main ]
  pull_request:
    paths:
      - 'Windows11_25H2_amd64/**'

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    # 1. æ£€å‡ºä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v5

    # 2. åˆ¶ä½œISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd %FILE_NAME%
        uup_download_windows.cmd

    # 3. æ‰“åŒ…
    - name: Package binaries
      shell: cmd
      run: |
        7z a -v1950M %FILE_NAME%-%Build_VERSION%.7z ./%FILE_NAME%/*.iso -mx=9

    # 4. ä¸Šä¼ åˆ°æ„å»ºäº§ç‰©
    - uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 120  # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
    # 1. æ£€å‡ºä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # 2. æ˜¾ç¤ºæ„å»ºä¿¡æ¯
    - name: Show build info
      shell: cmd
      run: |
        echo ========================================
        echo ğŸªŸ Windows 11 25H2 amd64 ISO æ„å»º
        echo ========================================
        echo æ„å»ºç‰ˆæœ¬: %Build_VERSION%
        echo æ–‡ä»¶ç›®å½•: %FILE_NAME%
        echo è§¦å‘æ–¹å¼: %GITHUB_EVENT_NAME%
        echo ========================================

    # 3. æ™ºèƒ½éƒ¨ç½²æ— äººå€¼å®ˆé…ç½®æ–‡ä»¶
    - name: Deploy autounattend.xml (æ™ºèƒ½é€‰æ‹©)
      id: deploy_config
      shell: powershell
      run: |
        Write-Host "å¼€å§‹éƒ¨ç½²æ— äººå€¼å®ˆé…ç½®æ–‡ä»¶..."
        Write-Host "ä¸»ç”¨é…ç½®è·¯å¾„: ${{ env.PRIMARY_CONFIG_PATH }}"
        Write-Host "å¤‡ç”¨é…ç½®è·¯å¾„: ${{ env.BACKUP_CONFIG_PATH }}"
        
        # åˆå§‹åŒ–è¾“å‡ºå˜é‡
        $configSource = "none"
        $configUsed = "false"
        
        # å¯¹äºpushå’Œpull_requestäº‹ä»¶ï¼Œç›´æ¥å°è¯•éƒ¨ç½²é…ç½®æ–‡ä»¶
        $githubEventName = "${{ github.event_name }}"
        
        if ($githubEventName -eq "workflow_dispatch") {
          # å¤„ç†æ‰‹åŠ¨è§¦å‘æ—¶çš„è¾“å…¥å‚æ•°
          $skipOEM = "${{ github.event.inputs.skip_oem_integration }}"
          $usePrimary = "${{ github.event.inputs.use_primary_config }}"
          
          Write-Host "æ‰‹åŠ¨è§¦å‘æ¨¡å¼"
          Write-Host "è·³è¿‡OEMé›†æˆ: $skipOEM"
          Write-Host "ä½¿ç”¨ä¸»ç”¨é…ç½®: $usePrimary"
          
          if ($skipOEM -eq "true") {
            Write-Host "â­ï¸ ç”¨æˆ·é€‰æ‹©è·³è¿‡æ— äººå€¼å®ˆé…ç½®é›†æˆï¼Œå°†æ„å»ºçº¯å‡€ISO"
            Write-Output "CONFIG_SOURCE=skipped"
            Write-Output "CONFIG_USED=false"
            exit 0
          }
          
          # æ£€æŸ¥ä¸»ç”¨é…ç½®
          if ($usePrimary -eq "true" -and (Test-Path "${{ env.PRIMARY_CONFIG_PATH }}")) {
            Write-Host "âœ… ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ä¸»ç”¨é…ç½®"
            $configSource = "primary"
            $configUsed = "true"
          } elseif (Test-Path "${{ env.BACKUP_CONFIG_PATH }}") {
            Write-Host "âœ… ä½¿ç”¨å¤‡ç”¨é…ç½®"
            $configSource = "backup"
            $configUsed = "true"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            if (-not (Test-Path "${{ env.TARGET_OEM_PATH }}")) {
              New-Item -ItemType Directory -Path "${{ env.TARGET_OEM_PATH }}" -Force | Out-Null
            }
            
            # å¤åˆ¶é…ç½®æ–‡ä»¶
            Copy-Item "${{ env.BACKUP_CONFIG_PATH }}" "${{ env.TARGET_OEM_PATH }}" -Force
          } else {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°å¯ç”¨é…ç½®æ–‡ä»¶"
          }
        } else {
          # è‡ªåŠ¨è§¦å‘æ¨¡å¼ï¼ˆpush/pull_requestï¼‰
          Write-Host "è‡ªåŠ¨è§¦å‘æ¨¡å¼ ($githubEventName)"
          
          # é¦–å…ˆæ£€æŸ¥ä¸»ç”¨é…ç½®
          if (Test-Path "${{ env.PRIMARY_CONFIG_PATH }}") {
            Write-Host "âœ… æ‰¾åˆ°ä¸»ç”¨é…ç½®"
            $configSource = "primary"
            $configUsed = "true"
          } elseif (Test-Path "${{ env.BACKUP_CONFIG_PATH }}") {
            Write-Host "âœ… æ‰¾åˆ°å¤‡ç”¨é…ç½®ï¼Œå°†å¤åˆ¶åˆ°ç›®æ ‡ä½ç½®"
            $configSource = "backup"
            $configUsed = "true"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            if (-not (Test-Path "${{ env.TARGET_OEM_PATH }}")) {
              New-Item -ItemType Directory -Path "${{ env.TARGET_OEM_PATH }}" -Force | Out-Null
            }
            
            # å¤åˆ¶é…ç½®æ–‡ä»¶
            Copy-Item "${{ env.BACKUP_CONFIG_PATH }}" "${{ env.TARGET_OEM_PATH }}" -Force
          } else {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
            $configSource = "none"
            $configUsed = "false"
          }
        }
        
        # è¾“å‡ºç»“æœ
        Write-Output "CONFIG_SOURCE=$configSource"
        Write-Output "CONFIG_USED=$configUsed"
        
        if ($configUsed -eq "true") {
          Write-Host "âœ… é…ç½®æ–‡ä»¶éƒ¨ç½²å®Œæˆ: ${{ env.TARGET_OEM_PATH }}autounattend.xml"
        } else {
          Write-Host "â„¹ï¸ æœªä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå°†æ„å»ºçº¯å‡€ISO"
        }

    # 4. éªŒè¯é…ç½®æ–‡ä»¶ (ä»…å½“ä½¿ç”¨é…ç½®æ—¶)
    - name: Validate autounattend.xml
      if: steps.deploy_config.outputs.CONFIG_USED == 'true'
      shell: powershell
      continue-on-error: true
      run: |
        $configPath = "${{ env.TARGET_OEM_PATH }}autounattend.xml"
        if (Test-Path $configPath) {
          Write-Host "éªŒè¯é…ç½®æ–‡ä»¶: $configPath"
          try {
            [xml]$config = Get-Content $configPath -ErrorAction Stop
            Write-Host "âœ… XMLè¯­æ³•éªŒè¯é€šè¿‡"
          } catch {
            Write-Warning "XMLè¯­æ³•éªŒè¯å¤±è´¥: $_"
          }
        } else {
          Write-Host "âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $configPath"
        }

    # 5. åˆ¶ä½œISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd %FILE_NAME%
        echo å½“å‰ç›®å½•: %CD%
        dir
        echo å¼€å§‹è¿è¡ŒUUPè½¬æ¢è„šæœ¬...
        echo å¼€å§‹æ—¶é—´: %time%
        uup_download_windows.cmd
        echo ç»“æŸæ—¶é—´: %time%
        echo UUPè½¬æ¢å®Œæˆ!

    # 6. æŸ¥çœ‹ç”Ÿæˆçš„ISOæ–‡ä»¶
    - name: Check generated ISO
      shell: cmd
      run: |
        cd %FILE_NAME%
        echo ISOæ–‡ä»¶ç”Ÿæˆä½ç½®: %CD%
        echo ç”Ÿæˆçš„ISOæ–‡ä»¶:
        dir *.iso
        if exist *.iso (
          for %%i in (*.iso) do (
            echo æ–‡ä»¶: %%~nxi
            echo å¤§å°: %%~zi å­—èŠ‚
          )
        ) else (
          echo âŒ æœªæ‰¾åˆ°ISOæ–‡ä»¶!
        )

    # 7. æ‰“åŒ…åˆ†å·å‹ç¼©
    - name: Package binaries
      shell: cmd
      run: |
        echo å¼€å§‹æ‰“åŒ…ISOæ–‡ä»¶...
        
        if not exist "%FILE_NAME%\*.iso" (
          echo âŒ é”™è¯¯: æœªæ‰¾åˆ°ISOæ–‡ä»¶!
          exit 1
        )
        
        set ARCHIVE_NAME=%FILE_NAME%-%Build_VERSION%
        
        where 7z >nul 2>nul
        if errorlevel 1 (
          echo æ­£åœ¨å®‰è£…7-Zip...
          curl -L https://www.7-zip.org/a/7zr.exe -o 7zr.exe
          set ZIP_TOOL=7zr.exe
        ) else (
          set ZIP_TOOL=7z
        )
        
        echo æ­£åœ¨åˆ›å»ºåˆ†å·å‹ç¼©åŒ…: %ARCHIVE_NAME%.7z
        %ZIP_TOOL% a -v1950M "%ARCHIVE_NAME%.7z" "./%FILE_NAME%/*.iso" -mx=9
        
        echo å‹ç¼©å®Œæˆ! ç”Ÿæˆçš„æ–‡ä»¶:
        dir "%ARCHIVE_NAME%.7z*"

    # 8. ä¸Šä¼ åˆ°æ„å»ºäº§ç‰©
    - uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*
        retention-days: 7
        if-no-files-found: error

    # 9. åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ (ä»…æ‰‹åŠ¨è§¦å‘æ—¶)
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}-${{ github.run_number }}
        name: Windows 11 25H2 amd64 (${{env.Build_VERSION}})
        body: |
          ## Windows 11 25H2 amd64 ISO
          
          ### æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ env.Build_VERSION }}
          - **æ„å»ºç¼–å·**: ${{ github.run_number }}
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          - **æ„å»ºæ—¶é—´**: ${{ github.run_started_at }}
          
          ### æ— äººå€¼å®ˆé…ç½®
          ${{ steps.deploy_config.outputs.CONFIG_USED == 'true' && format('- **é…ç½®æ–‡ä»¶**: {0}', steps.deploy_config.outputs.CONFIG_SOURCE == 'primary' && 'ä¸»ç”¨é…ç½®' || 'å¤‡ç”¨é…ç½®') || '- **é›†æˆçŠ¶æ€**: æœªé›†æˆ (çº¯å‡€ISO)' }}
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½æ‰€æœ‰ `.7z.001`, `.7z.002`... åˆ†å·æ–‡ä»¶
          2. ä½¿ç”¨ [7-Zip](https://www.7-zip.org/) è§£å‹ç¬¬ä¸€ä¸ªåˆ†å· (.7z.001)
          3. å¾—åˆ°å®Œæ•´çš„ Windows 11 ISO æ–‡ä»¶
          
          ---
          
          *æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºç”Ÿæˆï¼Œä»…ä¾›æµ‹è¯•å’Œå­¦ä¹ ä½¿ç”¨ã€‚*
          
        draft: false
        prerelease: false
        files: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*

    # 10. æ„å»ºå®Œæˆé€šçŸ¥
    - name: Build completion status
      if: always()
      shell: powershell
      run: |
        $status = "${{ job.status }}"
        Write-Host "========================================"
        Write-Host "ğŸ—ï¸  æ„å»ºä»»åŠ¡å®Œæˆ"
        Write-Host "========================================"
        Write-Host "ä»»åŠ¡çŠ¶æ€: $status"
        Write-Host "æ„å»ºç‰ˆæœ¬: ${{ env.Build_VERSION }}"
        Write-Host "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        Write-Host "é…ç½®æ–‡ä»¶: ${{ steps.deploy_config.outputs.CONFIG_SOURCE || 'æœªä½¿ç”¨' }}"
        Write-Host "========================================"
        
        if ($status -eq "success") {
          Write-Host "âœ… æ„å»ºæˆåŠŸ!"
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥!"
        }

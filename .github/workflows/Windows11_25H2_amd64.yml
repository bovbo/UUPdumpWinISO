name: Windows11_25H2_amd64

on: workflow_dispatch
# on: [push, pull_request]

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 270

    steps:
    # 1. 检出仓库
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # 2. 准备配置文件 (使用优化后的单一版本，顺序在构建前)
    - name: Prepare autounattend.xml
      shell: pwsh
      run: |
        $targetPath = "${{env.FILE_NAME}}/oem/$$/Panther/autounattend.xml"
        $targetDir = Split-Path $targetPath -Parent
        New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
        
        if (Test-Path $targetPath) {
            Write-Host "✓ 主配置文件已存在。"
        } elseif (Test-Path "Config/autounattend.xml") {
            Write-Host "⚠ 使用备用配置文件。"
            Copy-Item -Path "Config/autounattend.xml" -Destination $targetPath -Force
        } else {
            Write-Host "ℹ️ 未提供配置文件，UUP将使用默认配置。"
        }

    # 3. 制作ISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd ${{env.FILE_NAME}}
        echo "开始制作ISO..."
        uup_download_windows.cmd
        if %errorlevel% neq 0 (
          echo "ISO制作失败！"
          exit /b 1
        )

    # 4. 验证ISO文件
    - name: Verify ISO files
      shell: pwsh
      run: |
        Write-Host "验证ISO文件..."
        cd ${{env.FILE_NAME}}
        $isoFiles = Get-ChildItem -Filter "*.iso"
        if ($isoFiles.Count -eq 0) {
            Write-Error "❌ 未找到任何ISO文件，UUP脚本可能执行失败。"
            exit 1
        }
        Write-Host "✓ 成功找到 $($isoFiles.Count) 个ISO文件"

    # 5. 打包 (顺序在验证ISO之后)
    - name: Package binaries
      shell: cmd
      run: |
        echo "开始打包..."
        7z a -v1950M ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z ./${{env.FILE_NAME}}/*.iso -mx=9
        if errorlevel 1 (
          echo "打包失败！"
          exit /b 1
        )
        echo "打包完成"
        dir *.7z*

    # ================= 优化：分步上传至GitHub Releases =================
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # 使用commit SHA使每次运行的Tag唯一，避免冲突
        tag_name: build-${{ env.Build_VERSION }}-${{ github.sha }}
        name: Windows 11 25H2 Build ${{ env.Build_VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true

    - name: Upload Assets to Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # 注意：这里的tag_name必须与上一步完全相同
        tag_name: build-${{ env.Build_VERSION }}-${{ github.sha }}
        files: ./${{ env.FILE_NAME }}-${{ env.Build_VERSION }}.7z.*

    # ================= 【可选】自动清理旧版本Release =================
    # 注意：此步骤会立即删除旧版本。建议稳定运行后再启用，或调整keep_latest数量。
    - name: Cleanup Old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.0
      with:
        keep_latest: 3 # 建议先保留更多版本，如3个
        delete_tags: true
      env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ================= 最后：上传到 Actions Artifacts (7天缓存) =================
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z.*
        retention-days: 7

name: Windows11_25H2_amd64

on:
  workflow_dispatch:

env:
  BUILD_VERSION: "26200.7623"
  FILE_NAME: Windows11_25H2_amd64  

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 270

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Prepare autounattend.xml
        shell: pwsh
        run: |
          # 用 Join-Path + 单引号，确保 $$ 是字面量目录名（不会被 PowerShell 展开）
          $targetPath = Join-Path "${{ env.FILE_NAME }}" 'oem\$$\Panther\autounattend.xml'
          $targetDir  = Split-Path $targetPath -Parent
          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null

          if (Test-Path $targetPath) {  
            Write-Host "✓ 主配置文件已存在：$targetPath"
          } elseif (Test-Path 'Config/autounattend.xml') {
            Write-Host "⚠ 使用备用配置文件：Config/autounattend.xml"
            Copy-Item -Path 'Config/autounattend.xml' -Destination $targetPath -Force
          } else {
            Write-Host "ℹ️ 未提供配置文件，UUP将使用默认配置。"
          }

      - name: UUP dump WinISO
        shell: cmd
        run: |
          cd /d "%GITHUB_WORKSPACE%\${{ env.FILE_NAME }}"
          echo 开始制作ISO...
          call uup_download_windows.cmd
          if errorlevel 1 (
            echo ISO制作失败！
            exit /b 1
          )

      - name: Verify ISO files
        shell: pwsh
        run: |
          $isoDir = Join-Path "${{ env.FILE_NAME }}" ''
          $isoFiles = Get-ChildItem -Path $isoDir -Filter '*.iso' -File
          if (-not $isoFiles) { throw "❌ 未找到任何ISO文件，UUP脚本可能执行失败。" }

          Write-Host "✓ 成功找到 $($isoFiles.Count) 个ISO文件："
          $isoFiles | ForEach-Object { Write-Host " - $($_.FullName)" }

      - name: Package binaries
        shell: cmd
        run: |
          set "SEVENZIP=C:\Program Files\7-Zip\7z.exe"
          if not exist "%SEVENZIP%" set "SEVENZIP=7z"

          echo 开始打包...
          "%SEVENZIP%" a -v1950M "${{ env.FILE_NAME }}-${{ env.BUILD_VERSION }}.7z" "%GITHUB_WORKSPACE%\${{ env.FILE_NAME }}\*.iso" -mx=9
          if errorlevel 1 (
            echo 打包失败！
            exit /b 1
          )
          echo 打包完成
          dir "${{ env.FILE_NAME }}-${{ env.BUILD_VERSION }}.7z*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ env.BUILD_VERSION }}-${{ github.sha }}
          name: Windows 11 25H2 Build ${{ env.BUILD_VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Upload Assets to Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: build-${{ env.BUILD_VERSION }}-${{ github.sha }}
          files: ${{ env.FILE_NAME }}-${{ env.BUILD_VERSION }}.7z.*

      - name: Cleanup Old Releases
        uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-${{ env.BUILD_VERSION }}
          path: ${{ env.FILE_NAME }}-${{ env.BUILD_VERSION }}.7z.*
          retention-days: 7

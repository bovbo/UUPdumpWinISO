name: Windows11_25H2_amd64

on: workflow_dispatch
# on: [push, pull_request]

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 270

    steps:
    # 检出本仓库
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # 准备 autounattend.xml 配置文件 (优化容错逻辑)
    - name: Prepare autounattend.xml
      shell: pwsh
      run: |
        Write-Host "准备 autounattend.xml 配置文件..."
        $targetPath = "${{env.FILE_NAME}}/oem/$$/Panther/autounattend.xml"
        $targetDir = Split-Path $targetPath -Parent
        New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
        Write-Host "✓ 已确保目录存在: $targetDir"
        
        $mainConfig = "${{env.FILE_NAME}}/oem/$$/Panther/autounattend.xml"
        $backupConfig = "Config/autounattend.xml"
        
        if (Test-Path $mainConfig) {
            Write-Host "✓ 使用主配置文件。"
        } elseif (Test-Path $backupConfig) {
            Write-Host "⚠ 主配置文件不存在，使用备用配置文件。"
            Copy-Item -Path $backupConfig -Destination $targetPath -Force
        } else {
            Write-Host "ℹ️ 主备配置文件均不存在，UUP将使用其默认配置。"
        }

    # 制作ISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd ${{env.FILE_NAME}}
        echo "开始制作ISO..."
        uup_download_windows.cmd
        if %errorlevel% neq 0 (
          echo "ISO制作失败！"
          exit /b 1
        )

    # 验证ISO文件 (增加关键检查)
    - name: Verify ISO files
      shell: pwsh
      run: |
        Write-Host "验证ISO文件..."
        cd ${{env.FILE_NAME}}
        $isoFiles = Get-ChildItem -Filter "*.iso"
        if ($isoFiles.Count -eq 0) {
            Write-Error "❌ 致命错误：未找到任何ISO文件，UUP脚本可能执行失败。"
            Get-ChildItem -Recurse | Format-Table Name, Length -AutoSize
            exit 1
        }
        Write-Host "✓ 成功找到 $($isoFiles.Count) 个ISO文件"
        foreach ($iso in $isoFiles) {
            Write-Host "  - $($iso.Name) ($([math]::round($iso.Length/1GB, 2)) GB)"
        }

    # 打包 (修正：使用正确的shell)
    - name: Package binaries
      shell: cmd # 关键修正：此步骤使用批处理语法，必须指定为cmd
      run: |
        echo "开始打包..."
        7z a -v1950M ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z ./${{env.FILE_NAME}}/*.iso -mx=9
        if errorlevel 1 (
          echo "打包失败！"
          exit /b 1
        )
        echo "打包完成"
        dir *.7z*

    # 上传到Google Drive (使用官方Google Actions)
    # 上传到Google Drive (使用rclone命令行工具)
    - name: Upload to Google Drive with rclone
      shell: pwsh
      run: |
        # 1. 安装 rclone
        curl -O https://downloads.rclone.org/rclone-current-windows-amd64.zip
        Expand-Archive -Path rclone-current-windows-amd64.zip -DestinationPath .\rclone-temp
        Move-Item -Path .\rclone-temp\rclone-*-windows-amd64\rclone.exe -Destination .\rclone.exe

        # 2. 从 GitHub Secret 解码凭据并配置 rclone
        $credentialJson = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.GDRIVE_CREDENTIALS }}"))
        $credentialJson | Out-File -FilePath client_secret.json -Encoding utf8

        .\rclone.exe config create gdrive_remote drive config_is_local false --non-interactive
        .\rclone.exe config update gdrive_remote client_id ((Get-Content client_secret.json | ConvertFrom-Json).installed.client_id)
        .\rclone.exe config update gdrive_remote client_secret ((Get-Content client_secret.json | ConvertFrom-Json).installed.client_secret)
        .\rclone.exe config update gdrive_remote scope drive.file
        .\rclone.exe config update gdrive_remote token '{"access_token":"dummy","expiry":"2000-01-01"}' # 初始占位符

        # 3. 启动本地Web服务器进行OAuth授权 (需要手动操作)
        Write-Host "请复制以下链接到浏览器中完成授权："
        .\rclone.exe authorize "drive" --client-id ((Get-Content client_secret.json | ConvertFrom-Json).installed.client_id) --client-secret ((Get-Content client_secret.json | ConvertFrom-Json).installed.client_secret) --port 53682

        # 4. 将授权获取的token更新到配置
        $token = Read-Host "请输入上一步获取的token字符串"
        .\rclone.exe config update gdrive_remote token $token

        # 5. 上传文件到Google Drive (替换your_folder_id_here)
        .\rclone.exe copy -P .\${{ env.FILE_NAME }}-${{ env.Build_VERSION }}.7z* gdrive_remote:1RqedO6FcIk6uegGq9z8_Y2f_T-VObHf-/

    # 上传到Artifacts (备用)
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*
        retention-days: 7

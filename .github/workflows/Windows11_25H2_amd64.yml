name: Windows11_25H2_amd64

on: workflow_dispatch
# on: [push, pull_request]

env:
  Build_VERSION: '26200.7623'
  FILE_NAME: Windows11_25H2_amd64

jobs:
  Windows11_25H2_amd64:
    runs-on: windows-latest
    timeout-minutes: 270 # 为上传大文件预留充足时间

    steps:
    # 检出本仓库
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # 准备 autounattend.xml 配置文件
    - name: Prepare autounattend.xml
      shell: pwsh
      run: |
        Write-Host "准备 autounattend.xml 配置文件..."
        
        # 定义主备配置文件路径
        $mainConfig = "${{env.FILE_NAME}}/oem/$$/Panther/autounattend.xml"
        $backupConfig = "Config/autounattend.xml"
        $targetPath = "${{env.FILE_NAME}}/oem/$$/Panther/autounattend.xml"
        
        # 创建目标目录
        $targetDir = Split-Path $targetPath -Parent
        if (!(Test-Path $targetDir)) {
            New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
            Write-Host "✓ 创建目录: $targetDir"
        }
        
        # 检查并选择配置文件
        if (Test-Path $mainConfig) {
            Write-Host "✓ 主配置文件存在: $mainConfig"
            if ($mainConfig -ne $targetPath) {
                Copy-Item -Path $mainConfig -Destination $targetPath -Force
                Write-Host "✓ 主配置文件已复制到目标位置"
            }
        } elseif (Test-Path $backupConfig) {
            Write-Host "⚠ 主配置文件不存在，使用备用配置文件: $backupConfig"
            Copy-Item -Path $backupConfig -Destination $targetPath -Force
            Write-Host "✓ 备用配置文件已复制到目标位置"
        } else {
            Write-Warning "⚠ 主备配置文件均不存在，将使用UUP默认配置"
            Set-Content -Path $targetPath -Value "<!-- Auto unattend configuration will be generated by UUP -->"
        }
        
        if (Test-Path $targetPath) {
            $fileInfo = Get-Item $targetPath
            Write-Host "✓ 配置文件准备完成: $targetPath"
            Write-Host "  文件大小: $($fileInfo.Length) 字节"
        }

    # 制作ISO
    - name: UUP dump WinISO
      shell: cmd
      run: |
        cd ${{env.FILE_NAME}}
        echo "开始制作ISO..."
        uup_download_windows.cmd
        if %errorlevel% neq 0 (
          echo "ISO制作失败！"
          exit /b 1
        )

    # 验证ISO文件
    - name: Verify ISO files
      shell: pwsh
      run: |
        Write-Host "验证ISO文件..."
        cd ${{env.FILE_NAME}}
        $isoFiles = Get-ChildItem -Filter "*.iso"
        if ($isoFiles.Count -eq 0) {
            Write-Error "❌ 未找到ISO文件！"
            exit 1
        }
        Write-Host "✓ 找到 $($isoFiles.Count) 个ISO文件"

    # 打包
    - name: Package binaries
      run: |
        echo "开始打包..."
        7z a -v1950M ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z ./${{env.FILE_NAME}}/*.iso -mx=9
        if errorlevel 1 (
          echo "打包失败！"
          exit /b 1
        )
        echo "打包完成"

    # 上传到Google Drive (新增的核心步骤)
    - name: Upload to Google Drive
      uses: bonitasoft/gdrive-upload-action@v1
      with:
        # 1. 关键：必须已在GitHub仓库Secrets中配置 GDRIVE_CREDENTIALS
        credentials: ${{ secrets.GDRIVE_CREDENTIALS }}
        # 2. 关键：替换为您的Google Drive文件夹ID
        parent-folder-id: '1RqedO6FcIk6uegGq9z8_Y2f_T-VObHf-'
        # 上传打包好的分卷压缩文件
        source-filepath: ./${{ env.FILE_NAME }}-${{ env.Build_VERSION }}.7z*
        # (可选) 在云端重命名
        target-filepath: Windows11_25H2_amd64_自动构建.7z
        overwrite: true
        create-checksum: true

    # 上传到Artifacts (保留作为备用)
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.FILE_NAME}}-${{env.Build_VERSION}}
        path: ${{env.FILE_NAME}}-${{env.Build_VERSION}}.7z*
        retention-days: 7
